#!/usr/bin/env bash

set -efu

function sdebug {
  if [[ -n "${DEBUG:-}" ]]; then
    sdebug "$@" 1>&2
  fi
}

function call-main {
  if [[ -x /usr/local/opt/gnu-getopt/bin/getopt ]]; then
    export FLAGS_GETOPT_CMD=/usr/local/opt/gnu-getopt/bin/getopt
  fi

  source shflags

  DEFINE_string name 'world' "somebody's name" n
  options

  FLAGS "$@" || return $?
  eval set -- "${FLAGS_ARGV}"

  sdebug "exec: main $@"
  main "$@"
  return $?
}

function sub-main {
  local cmd="$1"; shift
  local bare_cmd="${cmd##*/}" 

  sdebug
  sdebug "cmd: $cmd"
  sdebug "bare-cmd; $bare_cmd"
  sdebug "args: $@"

  if [[ "$#" == 0 ]]; then
    call-main "$@"
    return $?
  fi

  local sub_cmd="$1"

  sdebug "finding: ${bare_cmd}-${sub_cmd}"
  found_cmd="$(type -P "${bare_cmd}-${sub_cmd}" || true)"
  if [[ -z "${found_cmd}" ]]; then
    call-main "$@"
    return $?
  fi

  shift
  sdebug "exec: ${bare_cmd}-${sub_cmd} $@"
  "${bare_cmd}-${sub_cmd}" "$@"
  return $?
}

sub-main "$@"
